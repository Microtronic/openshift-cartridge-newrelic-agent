#!/bin/bash -e

source $OPENSHIFT_CARTRIDGE_SDK_BASH

case "$1" in
  -v|--version)
    version="$2"
esac

# Create additional directories required
mkdir -p ${OPENSHIFT_NEWRELIC_DIR}/logs

# Add agent option
MASTER_PRE_START=${OPENSHIFT_REPO_DIR}/.openshift/action_hooks/pre_start_jbossas
NEWRELIC_AGENT="-javaagent:${OPENSHIFT_NEWRELIC_DIR}newrelic.jar"

if [ ! -e "${MASTER_PRE_START}" ]; then
  echo '#!/bin/bash' >> ${MASTER_PRE_START} 
  chmod 700 ${MASTER_PRE_START} 
fi

if [ -w "${MASTER_PRE_START}" ]; then
  echo >> $MASTER_PRE_START
  echo '#-- NEWRELIC: Enable agent' >> $MASTER_PRE_START
  echo '# DO NOT MODIFY!! This section is automatically generated by the newrelic cartridge.' >> $MASTER_PRE_START
  echo '#'
  echo -e "export _JAVA_OPTIONS=\"\${_JAVA_OPTIONS} ${NEWRELIC_AGENT}\"" >> $MASTER_PRE_START
  echo '#-- NEWRELIC: End enable agent' >> $MASTER_PRE_START
  echo >> $MASTER_PRE_START

else
  echo "WARNING: The file ${MASTER_PRE_START} is not writable."

fi

